<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spinify Dashboard â€¢ iOS 15 UI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: rgba(0,0,0,0.04);
      --panel-strong: rgba(0,0,0,0.08);
      --text: #0b0c0f;
      --muted: #4a5160;
      --tint: #0a84ff;
      --ok: #34c759;
      --warn: #ff9f0a;
      --danger: #ff3b30;
      --card-radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --chip: rgba(0,0,0,0.08);
    }
    html[data-theme="dark"] {
      --bg: #0b0c0f;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e9ecf1;
      --muted: #a9b0bc;
      --shadow: 0 8px 24px rgba(0,0,0,0.25);
      --chip: rgba(255,255,255,0.12);
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(10,132,255,0.08), transparent),
        radial-gradient(900px 600px at 110% 10%, rgba(255,255,255,0.06), transparent),
        var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 18px 14px 28px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo { width: 36px; height: 36px; border-radius: 11px; background: linear-gradient(135deg, var(--tint), #5aa3ff); box-shadow: var(--shadow); }
    .title { font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .sub { font-size: 12px; color: var(--muted); }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .seg { display: grid; grid-auto-flow: column; gap: 6px; align-items: center; background: var(--panel-strong); padding: 6px; border-radius: 12px; }
    .seg button { appearance: none; border: 0; background: transparent; color: var(--text); padding: 8px 10px; font-size: 13px; border-radius: 10px; cursor: pointer; }
    .seg button.active { background: var(--tint); color: white; }
    .toggle { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; background: var(--panel); border: 1px solid var(--panel-strong); cursor: pointer; user-select: none; font-size: 13px; color: var(--text); }
    .toggle input { display: none; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 640px) { .grid { grid-template-columns: repeat(4, 1fr); } }
    .card { grid-column: span 4; background: var(--panel); border: 1px solid var(--panel-strong); border-radius: var(--card-radius); box-shadow: var(--shadow); padding: 14px; display: flex; flex-direction: column; gap: 10px; backdrop-filter: blur(14px); }
    .card--wide { grid-column: span 8; }
    .card--full { grid-column: 1 / -1; }
    .card__head { display: flex; align-items: center; justify-content: space-between; }
    .card__title { font-weight: 700; font-size: 14px; letter-spacing: .2px; }
    .chip { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: var(--chip); color: var(--muted); }
    .stat { display: flex; align-items: baseline; gap: 8px; }
    .stat__value { font-size: 28px; font-weight: 800; }
    .stat__muted { font-size: 12px; color: var(--muted); }
    .input, textarea { width: 100%; background: rgba(0,0,0,0.03); color: var(--text); border: 1px solid var(--panel-strong); border-radius: 12px; padding: 10px 12px; font-size: 14px; outline: none; }
    html[data-theme="dark"] .input, html[data-theme="dark"] textarea { background: rgba(255,255,255,0.06); }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: flex; gap: 8px; }
    .btn { appearance: none; border: 0; background: var(--tint); color: white; padding: 10px 14px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 6px 14px rgba(10,132,255,0.35); }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--panel-strong); box-shadow: none; }
    .btn.ghost { background: transparent; color: var(--tint); border: 1px dashed var(--tint); box-shadow: none; }
    .btn.danger { background: var(--danger); box-shadow: 0 6px 14px rgba(255,59,48,0.35); }
    .list { display: grid; gap: 8px; }
    .item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid var(--panel-strong); border-radius: 12px; }
    .item .id { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 78%; }
    .footer { margin-top: 16px; display: flex; justify-content: space-between; align-items: center; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Spinify Dashboard</div>
          <div class="sub">iOS 15 look â€¢ Figma-ready â€¢ Responsive</div>
        </div>
      </div>
      <div class="header-actions">
        <label class="toggle" id="themeToggle">
          <input type="checkbox" id="themeCheckbox"/>
          <span id="themeLabel">ðŸŒž Light</span>
        </label>
        <button class="btn secondary" id="syncBtn">ðŸ”„ Sync</button>
        <button class="btn" id="closeBtn">Done</button>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <div class="card__head"><span class="card__title">Users</span><span class="chip">all</span></div>
        <div class="stat"><div class="stat__value" id="statUsers">0</div><div class="stat__muted">registered</div></div>
      </div>
      <div class="card">
        <div class="card__head"><span class="card__title">Active Users</span><span class="chip">sessions</span></div>
        <div class="stat"><div class="stat__value" id="statActive">0</div><div class="stat__muted">logged in</div></div>
      </div>
      <div class="card">
        <div class="card__head"><span class="card__title">Total Forwards</span><span class="chip">all-time</span></div>
        <div class="stat"><div class="stat__value" id="statForwards">0</div><div class="stat__muted">messages</div></div>
      </div>

      <div class="card card--wide">
        <div class="card__head"><span class="card__title">Posting Interval</span><span class="chip">minutes</span></div>
        <div class="seg" id="intervalSeg"></div>
        <div class="sub">Options are fixed to 30/45/60 to match worker.</div>
      </div>

      <div class="card card--full">
        <div class="card__head"><span class="card__title">Ad Composer</span><span class="chip" id="adCount">0/1024</span></div>
        <textarea id="adBox" placeholder="Write your adâ€¦"></textarea>
        <div class="row">
          <button class="btn" id="saveAd">ðŸ’¾ Save</button>
          <button class="btn secondary" id="sendTest">ðŸ§ª Send test</button>
        </div>
      </div>

      <div class="card card--wide">
        <div class="card__head"><span class="card__title">Groups</span><span class="chip" id="groupsChip">0 linked</span></div>
        <div class="row">
          <input class="input" id="grpInput" placeholder="@groupname or https://t.me/group" />
          <button class="btn" id="addGroup">âž• Add</button>
        </div>
        <div class="list" id="grpList"></div>
        <div class="row">
          <button class="btn ghost" id="importGroups">ðŸ“¥ Import list</button>
          <button class="btn danger" id="clearGroups">ðŸ§¹ Clear all</button>
        </div>
      </div>

      <div class="card">
        <div class="card__head"><span class="card__title">Top Users</span><span class="chip">sent</span></div>
        <div class="list" id="topList"></div>
        <div class="row"><button class="btn secondary" id="refreshTop">Refresh</button></div>
      </div>
    </section>

    <footer class="footer">
      <div>Dark/Light toggle remembers your choice â€¢ Powered by Telegram WebApp</div>
      <div class="sub">iOS 15 kit â€¢ glass cards â€¢ chips</div>
    </footer>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); try { tg.setHeaderColor("secondary_bg_color"); tg.setBackgroundColor("secondary_bg_color"); } catch (e) {} }

    // ---- API wiring ----
    const API_BASE = "https://YOUR_API_DOMAIN"; // e.g., https://api.spinify.in

    async function apiPost(path, payload = {}) {
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-Init-Data": (window.Telegram?.WebApp?.initData || "")
        },
        body: JSON.stringify(payload)
      });
      return res.json().catch(() => ({ ok: false }));
    }
    async function apiGet(path, q = {}) {
      const u = new URL(API_BASE + path);
      Object.entries(q).forEach(([k,v]) => u.searchParams.set(k, v));
      const res = await fetch(u, {
        headers: { "X-Telegram-Init-Data": (window.Telegram?.WebApp?.initData || "") }
      });
      return res.json().catch(() => ({ ok: false }));
    }

    // ---- Theme toggle ----
    const themeKey = 'spinify:theme';
    const themeCheckbox = document.getElementById('themeCheckbox');
    const themeLabel = document.getElementById('themeLabel');
    function applyTheme(pref) {
      const html = document.documentElement;
      if (pref === 'dark') { html.setAttribute('data-theme','dark'); themeCheckbox.checked = true; themeLabel.textContent = 'ðŸŒ™ Dark'; }
      else if (pref === 'light') { html.setAttribute('data-theme','light'); themeCheckbox.checked = false; themeLabel.textContent = 'ðŸŒž Light'; }
      else {
        const prefersDark = tg?.colorScheme === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches;
        html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        themeCheckbox.checked = prefersDark; themeLabel.textContent = prefersDark ? 'ðŸŒ™ Dark' : 'ðŸŒž Light';
      }
      localStorage.setItem(themeKey, pref);
    }
    const savedTheme = localStorage.getItem(themeKey) || 'auto';
    applyTheme(savedTheme);
    document.getElementById('themeToggle').addEventListener('click', (e) => {
      e.preventDefault();
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      // optional: notify bot
      try { tg.sendData(JSON.stringify({action:'set_theme', payload:{ theme: next }})); } catch(e){}
    }, false);

    // ---- State & helpers ----
    const state = { users: 0, active: 0, forwards: 0, interval: 30, ad: '', groups: [], top: [] };
    try { Object.assign(state, JSON.parse(localStorage.getItem('spinify:webapp')||'{}')); } catch(e){}
    function saveCache(){ localStorage.setItem('spinify:webapp', JSON.stringify(state)); }
    const $ = s => document.querySelector(s);

    // ---- Renderers ----
    function renderStats(){ $('#statUsers').textContent = state.users; $('#statActive').textContent = state.active; $('#statForwards').textContent = state.forwards; }
    function renderInterval(){
      const seg = $('#intervalSeg'); seg.innerHTML = '';
      [30,45,60].forEach(m => {
        const btn = document.createElement('button');
        btn.textContent = m + 'm'; if (m === state.interval) btn.classList.add('active');
        btn.onclick = async () => {
          state.interval = m; saveCache(); renderInterval();
          await apiPost("/api/set_interval", { minutes: m });
        };
        seg.appendChild(btn);
      });
    }
    function renderAd(){ const box = $('#adBox'); const c = $('#adCount'); box.value = state.ad||''; c.textContent = `${box.value.length}/1024`; }
    function renderGroups(){
      $('#groupsChip').textContent = `${state.groups.length} linked`;
      const list = $('#grpList'); list.innerHTML = '';
      state.groups.forEach((g,i) => {
        const row = document.createElement('div'); row.className = 'item';
        row.innerHTML = `<div class="id">${g}</div>`;
        const del = document.createElement('button'); del.className = 'btn secondary'; del.textContent = 'Remove';
        del.onclick = async () => {
          await apiPost("/api/remove_group", { group: g });
          state.groups.splice(i,1); saveCache(); renderGroups();
        };
        row.appendChild(del); list.appendChild(row);
      });
    }
    function renderTop(){
      const list = $('#topList'); list.innerHTML = '';
      (state.top||[]).forEach((u, idx) => {
        const row = document.createElement('div'); row.className = 'item';
        row.innerHTML = `<div class="id">${idx+1}. <b>${u.user_id}</b> @${u.username||'-'}</div><div>${u.sent_ok||0}</div>`;
        list.appendChild(row);
      });
    }

    // ---- Controls ----
    $('#saveAd').onclick = async () => {
      state.ad = $('#adBox').value.trim(); saveCache(); renderAd();
      await apiPost("/api/save_ad", { text: state.ad });
    };
    $('#sendTest').onclick = () => alert("Test-send handled by bot path (optional).");

    $('#adBox').addEventListener('input', () => $('#adCount').textContent = `${$('#adBox').value.length}/1024`);

    $('#addGroup').onclick = async () => {
      const v = $('#grpInput').value.trim(); if(!v) return;
      await apiPost("/api/add_group", { group: v });
      state.groups.push(v); $('#grpInput').value=''; saveCache(); renderGroups();
    };
    $('#importGroups').onclick = async () => {
      const text = prompt('Paste group links/usernames, one per line:'); if (!text) return;
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      if (lines.length) { await apiPost("/api/add_groups_bulk", { groups: lines }); state.groups.push(...lines); saveCache(); renderGroups(); }
    };
    $('#clearGroups').onclick = async () => {
      if (!confirm('Clear all groups?')) return;
      await apiPost("/api/clear_groups");
      state.groups = []; saveCache(); renderGroups();
    };

    $('#refreshTop').onclick = async () => {
      const j = await apiGet("/api/top", { limit: 10 }); state.top = j.top||[]; renderTop();
    };
    $('#syncBtn').onclick = syncAll;
    $('#closeBtn').onclick = () => { try { tg.close(); } catch(e) { alert('You can close this tab.'); } };

    // ---- Initial sync ----
    async function syncAll(){
      const j = await apiGet("/api/sync");
      if (j?.ok) {
        state.ad = j.ad || "";
        state.interval = j.interval || 30;
        state.groups = j.groups || [];
        state.users = j.stats?.users || 0;
        state.active = j.stats?.active || 0;
        state.forwards = j.stats?.forwards || 0;
        saveCache(); renderStats(); renderInterval(); renderAd(); renderGroups();
      }
      const top = await apiGet("/api/top", { limit: 10 });
      state.top = top.top||[]; renderTop();
    }

    renderStats(); renderInterval(); renderAd(); renderGroups(); renderTop();
    syncAll();
  </script>
</body>
</html>
